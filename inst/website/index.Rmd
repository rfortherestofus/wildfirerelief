---
title: "Wildfire Relief Data Visualization"
output:
  distill::distill_article:
    toc: FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      layout = "l-body-outset",
                      fig.height = 6)
```

```{r load_packages}
library(tidyverse)
library(devtools)
library(leaflet)
library(sf)
library(lubridate)
library(tfff)

load_all()
```

```{r load_data}
wildfires_2020_at_largest_date <- wildfires_2020 %>% 
  st_drop_geometry() %>% 
  mutate(date = as_date(polygon_date_time)) %>% 
  group_by(date) %>% 
  summarize(total_acres = sum(gis_acres, na.rm = TRUE)) %>% 
  drop_na(date) %>% 
  slice_max(total_acres, n = 1) %>% 
  pull(date)

wildfires_2020_at_largest_single_day <- wildfires_2020 %>% 
  mutate(date = as_date(polygon_date_time)) %>% 
  filter(date == wildfires_2020_at_largest_date)

wildfires_2020_at_largest <- wildfires_2020 %>% 
  group_by(incident_name) %>% 
  slice_max(gis_acres, n = 1, with_ties = FALSE) %>% 
  ungroup() 
```


```{r}
map_basemap <- function() {
  leaflet() %>%
    addProviderTiles(providers$CartoDB.Positron)
}
```


# Wildfires

## Wildfires 2020

This map shows the wildfires at their largest point in 2020. 

```{r}
map_wildfires <- function(leaflet_layers) {
  leaflet_layers %>%
    addPolygons(data = wildfires_2020_at_largest,
                group = "Wildfires",
                color = tfff_colors("Orange"),
                smoothFactor = 0.2,
                fillOpacity = 0.9,
                stroke = FALSE) 
}


map_basemap() %>% 
  map_wildfires()

```

## Wildfires 2020 Compared to Previous Years

I'll add this later on.

# COVID

Darker blue = more cases per capita

## COVID Cases: September 1

```{r}
map_covid <- function(leaflet_layers, 
                      observation_date,
                      group_name = NULL) {
  
  # pretty_date <- stamp_date("Mar 1")(ymd(observation_date))

  
  pal <- colorNumeric(
    palette = tinter::tinter(tfff_colors("Blue"),
                             steps = 5,
                             direction = "tints"),
    domain = covid_data$cases_seven_day_avg)
  
  leaflet_layers %>% 
    addPolygons(data = filter(covid_data, date == observation_date),
                group = group_name,
                color = ~pal(cases_seven_day_avg),
                smoothFactor = 0.2,
                fillOpacity = 0.5,
                stroke = 0.1) 
}
```

```{r}
map_basemap() %>% 
  map_covid("2020-09-01")  
```


## COVID Cases: October 1

```{r}
map_basemap() %>% 
  map_covid("2020-10-01")  
```

## COVID Cases: November 1

```{r}
map_basemap() %>% 
  map_covid("2020-11-01")  
```


# Communities

The yellow polygons show the borders of communities in Oregon and Siskiyou counties. 

```{r}
map_communities <- function(leaflet_layers) {
  leaflet_layers %>% 
    addPolygons(data = oregon_siskiyou_communities_geospatial,
                group = "Communities",
                color = tfff_colors("Yellow"),
                fillOpacity = 0.9,
                popup = ~community)
}

map_basemap() %>% 
  map_communities()
```


## Percent of Mobile Housing

Coming soon

## Distance from Communities to Nearest Hospital

Coming soon

# Rebuilding

## Hospitals

This shows hospitals in Oregon and Siskiyou. For some reason, they're not showing up, but they do show up in the combined map below

```{r}
map_hospitals <- function(leaflet_layers) {
  
  hospital_icon <- icons(
    iconUrl = here::here("inst", "resources", "images", "588-hospital.svg"),
    iconWidth = 22
  )
  
  leaflet_layers %>% 
    addMarkers(data = hospitals,
               group = "Hospitals",
               icon = hospital_icon,
               popup = ~name) 
}

map_basemap() %>% 
  map_hospitals()
```



## Clinics

At this point, I only have data for clinics from California. If you know of any source for Oregon data, please let me know. I've done some searching and haven't turned up anything.

```{r}
# map_basemap() %>% 
#   addCircleMarkers(data = clinics_california,
#                    popup = ~fac_name) 
```


# Combined Map

This map shows all of the above maps in a single map, with the ability to filter out certain layers. FYI, the COVID cases are for November 1.

```{r}
map_basemap() %>% 
  map_wildfires() %>% 
  map_covid("2020-11-01",
            group_name = "COVID Cases") %>%
  map_communities() %>% 
  map_hospitals() %>% 
  addLayersControl(
    overlayGroups = c("Wildfires", "Hospitals", "Communities", "COVID Cases"),
    options = layersControlOptions(collapsed = FALSE,
                                   autoZIndex = FALSE)) 
```


